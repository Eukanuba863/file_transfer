#!/bin/bash

# INSTALL docker STUFF FIRST!
# FOR s390x 'IBM Architecture' RHEL https://download.docker.com/linux/rhel/
# FOR x86_64 'AMD 64-bit Architecture" "CentOS" for RHEL https://download.docker.com/linux/centos/
# DOWNLOAD THE LATEST PACKAGES FOR THE ABOVE:
  # containerd.io-1.6.6-3.1.el8.x86_64.rpm
  # docker-ce-20.10.17-3.el8.x86_64.rpm
  # docker-ce-cli-20.10.17-3.el8.x86_64.rpm
  # docker-ce-rootless-extras-20.10.17-3.el8.x86_64.rpm
  # docker-compose-plugin-2.6.0-3.el8.x86_64.rpm
  # docker-scan-plugin-0.17.0-3.el8.x86_64.rpm
# INSTALL PACKAGES BY: sudo yum install /path/to/package.rpm
# ADD USER WHO WILL ADMINISTER THE DOCKER PROGRAM INTO THE "docker" GROUP: usermod -aG docker <ENTER_USERNAME_HERE>

# INSTALL docker-compose SECOND!
# DOWNLOAD APPROPRIATE docker-compose ARCHITECTURE FROM: https://github.com/docker/compose/releases
# RENAME THE PACKAGE (FOLLOWING EXAMPLE FOR x86_64 ARCHIT): mv docker-compose-Linux-x86_64 docker-compose
# MOVE FILE TO EXECUTABLE PATH: sudo mv docker-compose /usr/local/bin/
# ALLOW EXECUTABLE ACLS FOR THE FILE: sudo chmod +x /usr/local/bin/docker-compose

# ADD DOCKER IMAGES
# DOWNLOAD SUPPLIED IMAGES:
  # hello-world-latest_docker_image.tar (SHA256SUM: 9a88a2b9a37532e1d6f063adc80bf892e5e671927c5beb2adc713b7c9220cc77)
  # gitea-1.16.8_docker_image.tar       (SHA256SUM: 6f549ae8d12f611eea6a5a9c26316829718785e33de95fcf97803adf0cc5ecc7)
  # postgres-14_docker_image.tar        (SHA256SUM: 58f60874f6c09fa05f21093e91781eff3528d9c6cc804620b5e6f681dc8d9854)
# IMPORT IMAGES INTO DOCKER WITH: docker import <FILENAME_OF_IMAGE> <IMAGE_NAME_HERE>:<VERSION_HERE>
  # SHOULD BE THE FOLLOWING:
    # docker import hello-world-latest_docker_image.tar hello-world:latest
    # docker import gitea-1.16.8_docker_image.tar gitea:1.16.8
    # docker import postgres-14_docker_image.tar postgres:14
# CHECK THAT ALL IMAGES WERE IN-FACT IMPORTED: docker images
  
# MAY NEED TO REBOOT COMPUTER NOW...

# CHECK THAT DOCKER IS RUNNING SUCCESSFULLY: docker run hello-world

# IF IT WORKED DO THE BELOW STEPS!!! YOU'RE ALMOST THERE!

# RUN THIS SCRIPT TO START gitea AND postgres
# !!!CHECK SCRIPT BELOW FOR FILENAME/PORT/NAMING DESIRED CHANGES!!!
# CHANGE NAME OF THIS SCRIPT: mv ./gitea_install.txt ./gitea_install.sh
# CHANGE PERMISSIONS FOR USER WHO WILL ADMINISTER DOCKER: chmod 744 ./gitea_install.sh
# RUN THIS SCRIPT AS USER WHO WILL ADMINISTER DOCKER: bash ./gitea_install.sh

function _INSTALL_GITEA {
  echo ""
  echo "##########"
  echo "PREPARING FOR gitea INSTALL"
  echo "##########"
  #INITIAL VARIABLES AND SETUP
  #THIS SCRIPT ASSUMES THE DATABASE WILL BE INSTALLED IN ~
  export COMPOSE_PROJECT_NAME="gitea_$(date +%Y_%m_%d_%H_%M_%S)"
  USERFOLDER="$(echo ~)/${COMPOSE_PROJECT_NAME}"
  mkdir -v ${USERFOLDER}
  echo ""
  #START SPECIFIC gitea/postgres CONFIG BELOW
  docker-compose -f - up -d <<EOM
version: "3"

networks:
  gitea:
    external: false

services:
  server:
    image: gitea/gitea:1.16.8
    container_name: gitea
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=db:30000
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=gitea
    restart: always
    networks:
      - gitea
    volumes:
      - ~/${COMPOSE_PROJECT_NAME}/gitea:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "3000:3000"
      - "222:22"
    depends_on:
      - db

  db:
    image: postgres:14
    container_name: gitea_postgres_db
    restart: always
    environment:
      - POSTGRES_USER=gitea
      - POSTGRES_PASSWORD=gitea
      - POSTGRES_DB=gitea
    networks:
      - gitea
    volumes:
      - ~/${COMPOSE_PROJECT_NAME}/postgresql:/var/lib/postgresql/data
EOM
}

# RUN THE INSTALL SCRIPT
_INSTALL_GITEA